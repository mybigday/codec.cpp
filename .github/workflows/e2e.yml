name: E2E Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/ops/**'
      - 'src/models/**'
      - 'tests/e2e/**'
      - 'requirements-e2e.txt'
      - '.github/workflows/e2e.yml'
  pull_request:
    types: [ opened, synchronize, reopened ]
    paths:
      - 'src/ops/**'
      - 'src/models/**'
      - 'tests/e2e/**'
      - 'requirements-e2e.txt'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  e2e-test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache models
      uses: actions/cache@v4
      with:
        path: models/
        key: codec-models-${{ hashFiles('tests/e2e/config.json') }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential pkg-config python3-pip ffmpeg sox

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: requirements-e2e.txt

    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install -r requirements-e2e.txt

    - name: Build C++
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
        cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

    - name: Verify CLI
      run: |
        test -f build/codec-cli
        ./build/codec-cli 2>&1 | head -5 || true

    - name: Run E2E tests
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python3 tests/e2e/runner.py --report-dir tests/e2e/reports

    - name: Upload E2E reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-reports
        path: tests/e2e/reports/
        if-no-files-found: error
